<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>opihiexarata.photometry.solution &mdash; OpihiExarata 2023.6.27 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/pyukumuku_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            OpihiExarata
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">User Manual</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user/opihi_telescope.html">Opihi Telescope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/system_framework.html">System Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/system_framework.html#engines">Engines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/system_framework.html#vehicles-and-solutions">Vehicles and Solutions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/command_line.html">Command Line</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/command_line.html#available-actions">Available Actions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#manual">Manual</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#automatic">Automatic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#generate">Generate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#help">Help</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/command_line.html#available-options">Available Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#id1">Help</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#id2">Manual</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#id3">Automatic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#secrets">Secrets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#overwrite">Overwrite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/command_line.html#keep-temporary">Keep Temporary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/manual_mode.html">Manual Mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/manual_mode.html#graphical-user-interface">Graphical User Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/manual_mode.html#procedure">Procedure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#start-and-open-gui">Start and Open GUI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#specify-new-target-name">Specify New Target Name</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#take-and-image">Take and Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#find-asteroid-location">Find Asteroid Location</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../user/manual_mode.html#target-selector-gui">Target Selector GUI</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#compute-astrometric-solution">Compute Astrometric Solution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#compute-photometric-solution">Compute Photometric Solution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#asteroid-on-sky-position">Asteroid On-Sky Position</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#historical-observations">Historical Observations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#asteroid-observation-record">Asteroid Observation Record</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#asteroid-position-propagation">Asteroid Position Propagation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#orbital-elements">Orbital Elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#ephemeris">Ephemeris</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#asteroid-on-sky-future-track">Asteroid On-Sky Future Track</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/manual_mode.html#telescope-control-software-update">Telescope Control Software: Update</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/automatic_mode.html">Automatic Mode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/automatic_mode.html#graphical-user-interface">Graphical User Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/automatic_mode.html#procedure">Procedure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#start-and-open-gui">Start and Open GUI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#specify-data-directory">Specify Data Directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#specify-solving-engines">Specify Solving Engines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#trigger-continuous-images">Trigger Continuous Images</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#trigger-automatic-solving">Trigger Automatic Solving</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../user/automatic_mode.html#trigger-once-manually">Trigger Once Manually</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#displayed-status-and-results">Displayed Status and Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/automatic_mode.html#stop-automatic-solving">Stop Automatic Solving</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/configuration.html">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/configuration.html#standard-configuration-file">Standard Configuration File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/configuration.html#secrets-configuration-file">Secrets Configuration File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/recording_fits_file.html">Recording FITS File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/recording_fits_file.html#header-naming-convention">Header Naming Convention</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/zero_point_monitoring.html">Zero Point Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/troubleshooting.html#automatic-mode-stop-button-not-working">Automatic Mode Stop Button Not Working</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/troubleshooting.html#pyside-gui-does-not-match-documentation-or-ui-files">PySide GUI Does Not Match Documentation or UI Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/citations.html">Citations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/citations.html#references">References</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#nasa-infrared-telescope-facility">NASA Infrared Telescope Facility</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#mast">MAST</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#minor-planet-center">Minor Planet Center</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#scipy">Scipy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#matplotlib">Matplotlib</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#astropy">Astropy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#numpy">Numpy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#gaia">Gaia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#pan-starrs1">Pan-STARRS1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#jpl-horizons">JPL Horizons</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#astrometry-net">Astrometry.net</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/citations.html#acknowledgements">Acknowledgements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user/citations.html#opihiexarata-processing-image">OpihiExarata Processing Image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/trivia.html">Trivia</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/trivia.html#etymology-of-opihiexarata">Etymology of OpihiExarata</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../technical/index.html">Technical Manual</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../technical/installation/index.html">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/installation/index.html#automated-scripts">Automated Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/index.html#script-usage">Script Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/installation/index.html#manual-installation">Manual Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/download.html">Install: Download</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/download.html#via-git-recommended">Via git (Recommended)</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/download.html#via-zip-archive">Via .zip Archive</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/python.html">Install: Python Part</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/python.html#download">Download</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/python.html#build">Build</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/python.html#install">Install</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/documentation.html">Optional: Documentation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/documentation.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/documentation.html#build">Build</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/windows.html">Optional: Windows Compatibility</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/windows.html#powershell-execution-policy">Powershell Execution Policy</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/windows.html#windows-subsystem-for-linux">Windows Subsystem for Linux</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/windows.html#verify">Verify</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/windows.html#final">Final</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/installation/orbfit.html">Install: Orbfit</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#download-orbfit">Download OrbFit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#compile">Compile</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#download-jpl-ephemerides-file">Download JPL Ephemerides File</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#testing-suite">Testing Suite</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#executable-path-for-configuration-file">Executable Path for Configuration File</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/installation/orbfit.html#opihiexarata-template-files">OpihiExarata Template Files</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../technical/architecture/index.html">Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/architecture/services_engines.html">Services and Engines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/services_engines.html#astrometryengines">AstrometryEngines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#astrometry-net-nova">Astrometry.net Nova</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/services_engines.html#photometryengines">PhotometryEngines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#pan-starrs-3pi-dr2-mast">Pan-STARRS 3pi DR2 MAST</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/services_engines.html#orbitengines">OrbitEngines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#orbfit">OrbFit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#custom-orbit">Custom Orbit</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/services_engines.html#ephemerisengines">EphemerisEngines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#jpl-horizons">JPL Horizons</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/services_engines.html#propagationengine">PropagationEngine</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#linear">Linear</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/services_engines.html#quadratic">Quadratic</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html">Vehicles and Solutions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#vehicles">Vehicles</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#astrometry-vehicle-functions">Astrometry Vehicle Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#photometry-vehicle-functions">Photometry Vehicle Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#orbit-vehicle-functions">Orbit Vehicle Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#ephemeris-vehicle-functions">Ephemeris Vehicle Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#propagation-vehicle-functions">Propagation Vehicle Functions</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#solution">Solution</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#opihisolution">OpihiSolution</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#opihipreprocesssolution">OpihiPreprocessSolution</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/architecture/vehicles_solutions.html#opihizeropointdatabasesolution">OpihiZeroPointDatabaseSolution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/architecture/library.html">Library</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#conversion">Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#engines">Engines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#error">Error</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#fits-file-handing">FITS File Handing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#type-hinting">Type Hinting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#http-calls">HTTP Calls</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#image-array-processing">Image Array Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#json-parsing">JSON Parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#minor-planet-center-records">Minor Planet Center Records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#file-and-directory-path-manipulations">File and Directory Path Manipulations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#photometric-and-astrometric-data-handing-table">Photometric and Astrometric Data Handing Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#telescope-control-software">Telescope Control Software</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/library.html#temporary-directory">Temporary Directory</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/architecture/graphical_user_interface.html">Graphical User Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/graphical_user_interface.html#qt-designer">Qt Designer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/graphical_user_interface.html#building-ui-files">Building UI Files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/architecture/monitor_database.html">Monitor Database</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/monitor_database.html#database-schema">Database Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/architecture/monitor_database.html#managing-the-database">Managing the Database</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../technical/conventions.html">Conventions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/conventions.html#sky-coordinate-systems">Sky-Coordinate Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/conventions.html#units">Units</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/conventions.html#code-style">Code Style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/conventions.html#formatting-style">Formatting Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/conventions.html#type-hinting">Type Hinting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/conventions.html#documentation-files">Documentation Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/conventions.html#main-body-files">Main Body Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/conventions.html#image-files">Image Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/conventions.html#python-docstrings">Python Docstrings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/conventions.html#filter-names">Filter Names</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../technical/algorithms/index.html">Algorithms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/algorithms/photometric_zero_point.html">Photometric Zero Point</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/photometric_zero_point.html#calculating-magnitude">Calculating Magnitude</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/photometric_zero_point.html#filtering-considerations">Filtering Considerations</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/algorithms/photometric_zero_point.html#limiting-by-magnitude">Limiting by Magnitude</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/algorithms/polynomial_propagation.html">Polynomial Propagation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/polynomial_propagation.html#coordinate-conversion">Coordinate Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/polynomial_propagation.html#fitting-coordinates">Fitting Coordinates</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/algorithms/polynomial_propagation.html#wrap-around">Wrap Around</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html">Spherical Kinematics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#definitions">Definitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#deriving-rates">Deriving Rates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#spherical-motion">Spherical Motion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#celestial-sphere">Celestial Sphere</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#lemmas">Lemmas</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../technical/algorithms/spherical_kinematics.html#derivation-of-vector-equation-of-motion">Derivation of Vector Equation of Motion</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../technical/license.html">License</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code/modules.html">opihiexarata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../code/opihiexarata.html">opihiexarata package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../code/opihiexarata.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.astrometry.html">opihiexarata.astrometry package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.astrometry.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.astrometry.html#module-opihiexarata.astrometry">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.ephemeris.html">opihiexarata.ephemeris package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.ephemeris.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.ephemeris.html#module-opihiexarata.ephemeris">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.gui.html">opihiexarata.gui package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.gui.html#subpackages">Subpackages</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.gui.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.gui.html#module-opihiexarata.gui">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.library.html">opihiexarata.library package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.library.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.library.html#module-opihiexarata.library">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.opihi.html">opihiexarata.opihi package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.opihi.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.opihi.html#module-opihiexarata.opihi">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.orbit.html">opihiexarata.orbit package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.orbit.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.orbit.html#module-opihiexarata.orbit">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.photometry.html">opihiexarata.photometry package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.photometry.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.photometry.html#module-opihiexarata.photometry">Module contents</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.propagate.html">opihiexarata.propagate package</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.propagate.html#submodules">Submodules</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.propagate.html#module-opihiexarata.propagate">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/opihiexarata.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../code/opihiexarata.__main__.html">opihiexarata.__main__ module</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.__main__.html#opihiexarata.__main__.__main_execute_arguments"><code class="docutils literal notranslate"><span class="pre">__main_execute_arguments()</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.__main__.html#opihiexarata.__main__.__main_parse_arguments"><code class="docutils literal notranslate"><span class="pre">__main_parse_arguments()</span></code></a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../code/opihiexarata.__main__.html#opihiexarata.__main__.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/opihiexarata.html#module-opihiexarata">Module contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OpihiExarata</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">opihiexarata.photometry.solution</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for opihiexarata.photometry.solution</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The general photometric solver.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">astropy.table</span> <span class="k">as</span> <span class="nn">ap_table</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">sp_stats</span>

<span class="kn">import</span> <span class="nn">opihiexarata.library</span> <span class="k">as</span> <span class="nn">library</span>
<span class="kn">import</span> <span class="nn">opihiexarata.library.error</span> <span class="k">as</span> <span class="nn">error</span>
<span class="kn">import</span> <span class="nn">opihiexarata.library.hint</span> <span class="k">as</span> <span class="nn">hint</span>

<span class="kn">import</span> <span class="nn">opihiexarata.astrometry</span> <span class="k">as</span> <span class="nn">astrometry</span>
<span class="kn">import</span> <span class="nn">opihiexarata.photometry</span> <span class="k">as</span> <span class="nn">photometry</span>


<div class="viewcode-block" id="PhotometricSolution"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution">[docs]</a><span class="k">class</span> <span class="nc">PhotometricSolution</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">ExarataSolution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The primary class describing an photometric solution, based on an image</span>
<span class="sd">    provided and catalog data provided from the photometric engine.</span>

<span class="sd">    This class is the middleware class between the engines which solve the</span>
<span class="sd">    photometry, and the rest of the OpihiExarata code.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _original_filename : string</span>
<span class="sd">        The original filename where the fits file is stored at, or copied to.</span>
<span class="sd">    _original_header : Header</span>
<span class="sd">        The original header of the fits file that was pulled to solve for this</span>
<span class="sd">        astrometric solution.</span>
<span class="sd">    _original_data : array-like</span>
<span class="sd">        The original data of the fits file that was pulled to solve for this</span>
<span class="sd">        photometric solution.</span>
<span class="sd">    astrometrics : AstrometricSolution</span>
<span class="sd">        The astrometric solution that is required for the photometric solution.</span>
<span class="sd">    sky_counts : float</span>
<span class="sd">        The average sky contribution per pixel.</span>
<span class="sd">    star_table : Table</span>
<span class="sd">        A table of stars around the image with their RA, DEC, and filter</span>
<span class="sd">        magnitudes. It is not guaranteed that this star table and the</span>
<span class="sd">        astrometric star table is correlated.</span>
<span class="sd">    intersection_star_table : Table</span>
<span class="sd">        A table of stars with both the astrometric and photometric RA and DEC</span>
<span class="sd">        coordinates found by the astrometric solution and the photometric</span>
<span class="sd">        engine. The filter magnitudes of these stars are also provided. It is</span>
<span class="sd">        guaranteed that the stars within this table are correlated.</span>
<span class="sd">    exposure_time : float</span>
<span class="sd">        How long, in seconds, the image in question was exposed for.</span>
<span class="sd">    filter_name : string</span>
<span class="sd">        A single character string describing the name of the filter band that</span>
<span class="sd">        this image was taken in. Currently, it assumes the MKO/SDSS visual</span>
<span class="sd">        filters.</span>
<span class="sd">    aperture_radius : float</span>
<span class="sd">        The aperture radius that defines the aperture for aperture photometry,</span>
<span class="sd">        in arcseconds.</span>
<span class="sd">    available_filters : tuple</span>
<span class="sd">        The list of filter names which the star table currently covers and has</span>
<span class="sd">        data for.</span>
<span class="sd">    zero_point : float</span>
<span class="sd">        The zero point of the image.</span>
<span class="sd">    zero_point_error : float</span>
<span class="sd">        The standard deviation of the error point mean as calculated using</span>
<span class="sd">        many stars.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PhotometricSolution.__init__"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fits_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">solver_engine</span><span class="p">:</span> <span class="n">hint</span><span class="o">.</span><span class="n">PhotometryEngine</span><span class="p">,</span>
        <span class="n">astrometrics</span><span class="p">:</span> <span class="n">hint</span><span class="o">.</span><span class="n">AstrometricSolution</span><span class="p">,</span>
        <span class="n">exposure_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vehicle_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization of the photometric solution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fits_filename : string</span>
<span class="sd">            The path of the fits file that contains the data for the astrometric</span>
<span class="sd">            solution.</span>
<span class="sd">        solver_engine : PhotometryEngine</span>
<span class="sd">            The photometric solver engine class. This is what will act as the</span>
<span class="sd">            &quot;behind the scenes&quot; and solve the field, using this middleware to</span>
<span class="sd">            translate it into something that is easier.</span>
<span class="sd">        astrometrics : AstrometricSolution, default = None</span>
<span class="sd">            A precomputed astrometric solution which belongs to this image.</span>
<span class="sd">        exposure_time : float, default = None</span>
<span class="sd">            How long, in seconds, the image in question was exposed for. If</span>
<span class="sd">            not provided, calculation of the zero-point is skipped.</span>
<span class="sd">        filter_name : string, default = None</span>
<span class="sd">            A single character string describing the name of the filter band that</span>
<span class="sd">            this image was taken in. Currently, it assumes the MKO/SDSS visual</span>
<span class="sd">            filters. If it is None, calculation of the zero-point is skipped.</span>
<span class="sd">        vehicle_args : dictionary</span>
<span class="sd">            If the vehicle function for the provided solver engine needs</span>
<span class="sd">            extra parameters not otherwise provided by the standard input,</span>
<span class="sd">            they are given here.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># It is a core assumption that the astrometric solution and this</span>
        <span class="c1"># photometric solution is working on the same file.</span>
        <span class="k">if</span> <span class="n">fits_filename</span> <span class="o">!=</span> <span class="n">astrometrics</span><span class="o">.</span><span class="n">_original_filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span>
                <span class="s2">&quot;The astrometric solution solved an image file different than the image&quot;</span>
                <span class="s2">&quot; this photometric solution is trying to solve. It is assumed that the&quot;</span>
                <span class="s2">&quot; input astrometric solution and this photometric solution is solving&quot;</span>
                <span class="s2">&quot; the same image.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check that the solver engine is a valid submission, that is is an</span>
        <span class="c1"># expected engine class.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solver_engine</span><span class="p">,</span> <span class="n">library</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">PhotometryEngine</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">EngineError</span><span class="p">(</span>
                <span class="s2">&quot;The photometric solver engine provided should be the engine class&quot;</span>
                <span class="s2">&quot; itself, not an instance thereof.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">solver_engine</span><span class="p">,</span> <span class="n">library</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">PhotometryEngine</span><span class="p">):</span>
            <span class="c1"># It is fine, the user submitted a valid photometric engine.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">EngineError</span><span class="p">(</span>
                <span class="s2">&quot;The provided photometric engine is not a valid engine which can be&quot;</span>
                <span class="s2">&quot; used for photometric solutions.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Check that the astrometric solution is a valid solution.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astrometrics</span><span class="p">,</span> <span class="n">astrometry</span><span class="o">.</span><span class="n">AstrometricSolution</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span>
                <span class="s2">&quot;A precomputed astrometric solution is required for the computation of&quot;</span>
                <span class="s2">&quot; the photometric solution. It must be an AstrometricSolution class&quot;</span>
                <span class="s2">&quot; from OpihiExarata.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span> <span class="o">=</span> <span class="n">astrometrics</span>

        <span class="c1"># Extract information from the header itself.</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">read_fits_image_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fits_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_filename</span> <span class="o">=</span> <span class="n">fits_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Derive the photometric star table.</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">solver_engine</span><span class="p">,</span> <span class="n">photometry</span><span class="o">.</span><span class="n">PanstarrsMastWebAPIEngine</span><span class="p">):</span>
            <span class="c1"># Solve using the API.</span>
            <span class="n">photometry_results</span> <span class="o">=</span> <span class="n">_vehicle_panstarrs_mast_web_api</span><span class="p">(</span>
                <span class="n">ra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                <span class="n">dec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There is no vehicle function, the engine is not supported.</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">EngineError</span><span class="p">(</span>
                <span class="s2">&quot;The provided astrometric engine `</span><span class="si">{eng}</span><span class="s2">` is not supported, there is no&quot;</span>
                <span class="s2">&quot; associated vehicle function for it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eng</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">solver_engine</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># Get the results of the solution. If the engine did not provide all of</span>
        <span class="c1"># the needed values, then the engine is deficient.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star_table</span> <span class="o">=</span> <span class="n">photometry_results</span><span class="p">[</span><span class="s2">&quot;star_table&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_filters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">photometry_results</span><span class="p">[</span><span class="s2">&quot;available_filters&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">EngineError</span><span class="p">(</span>
                <span class="s2">&quot;The engine results provided are insufficient for this photometric&quot;</span>
                <span class="s2">&quot; solver. Either the engine cannot be used because it cannot provide&quot;</span>
                <span class="s2">&quot; the needed results, or the vehicle function does not pull the&quot;</span>
                <span class="s2">&quot; required results from the engine.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Double check that the photometric star table has the proper columns</span>
        <span class="c1"># and conforms to the expectations of the photometric vehicle functions.</span>
        <span class="c1"># The order of the columns do not matter, if it has extra columns as</span>
        <span class="c1"># well, it does not matter.</span>
        <span class="n">expected_colnames</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">phototable</span><span class="o">.</span><span class="n">PHOTOMETRY_TABLE_COLUMN_NAMES</span>
        <span class="k">for</span> <span class="n">colnamedex</span> <span class="ow">in</span> <span class="n">expected_colnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colnamedex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">EngineError</span><span class="p">(</span>
                    <span class="s2">&quot;The photometric engine does not generate a star table which has&quot;</span>
                    <span class="s2">&quot; the correct expected magnitude columns. The engine or the vehicle&quot;</span>
                    <span class="s2">&quot; may not be sufficient. The star table&#39;s columns may also have&quot;</span>
                    <span class="s2">&quot; incorrect names.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># The aperture size as determined by the configuration file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture_radius</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_STAR_RADIUS_ARCSECOND</span>

        <span class="c1"># Determine the average sky contribution per pixel.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky_counts_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_sky_counts_mask</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_sky_counts_value</span><span class="p">()</span>

        <span class="c1"># Derive the intersection star table from the photometric results and the</span>
        <span class="c1"># astrometric solution. The data table is also used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_star_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_intersection_star_table</span><span class="p">()</span>

        <span class="c1"># Calculating the zero point of this filter image as it is part of the</span>
        <span class="c1"># photometric solution.</span>
        <span class="k">if</span> <span class="n">exposure_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">filter_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Both is needed to compute the zero point, skip it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_point</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zero</span><span class="p">,</span> <span class="n">zero_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_zero_point</span><span class="p">(</span>
                <span class="n">exposure_time</span><span class="o">=</span><span class="n">exposure_time</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="n">filter_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="n">exposure_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_point</span> <span class="o">=</span> <span class="n">zero</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_error</span> <span class="o">=</span> <span class="n">zero_err</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_name</span>

        <span class="c1"># All done.</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__calculate_intersection_star_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hint</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function determines the intersection star table.</span>

<span class="sd">        Basically this function matches the entries in the astrometric star</span>
<span class="sd">        table with the photometric star table. This function accomplishes that</span>
<span class="sd">        by simply associating the closest entires as the same star. The</span>
<span class="sd">        distance function assumes a tangent sky projection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        intersection_table : Table</span>
<span class="sd">            The intersection of the astrometric and photometric star tables</span>
<span class="sd">            giving the correlated star entries between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The astrometric and photometric tables to be worked with. This</span>
        <span class="c1"># functions should be called after they exist so this is fine. This</span>
        <span class="c1"># also makes the code a little more readable.</span>
        <span class="n">astrometric_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">star_table</span>
        <span class="n">photometric_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_table</span>

        <span class="c1"># The intersection table. The columns are just both tables joined.</span>
        <span class="c1"># The first entries are just hard-coded to be first because they are</span>
        <span class="c1"># the basic required columns.</span>
        <span class="n">base_columns</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">phototable</span><span class="o">.</span><span class="n">INTERSECTION_ASTROPHOTO_TABLE_COLUMN_NAMES</span>
        <span class="c1">#</span>
        <span class="n">intersection_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">base_columns</span> <span class="o">+</span> <span class="n">astrometric_table</span><span class="o">.</span><span class="n">colnames</span> <span class="o">+</span> <span class="n">photometric_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Making the table.</span>
        <span class="n">intersection_table</span> <span class="o">=</span> <span class="n">ap_table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">intersection_colnames</span><span class="p">)</span>

        <span class="c1"># The RA and DEC of the photometric tables. Cache them as variables</span>
        <span class="c1"># is a little more time efficient.</span>
        <span class="n">ra_phototable</span> <span class="o">=</span> <span class="n">photometric_table</span><span class="p">[</span><span class="s2">&quot;ra_photo&quot;</span><span class="p">]</span>
        <span class="n">dec_phototable</span> <span class="o">=</span> <span class="n">photometric_table</span><span class="p">[</span><span class="s2">&quot;dec_photo&quot;</span><span class="p">]</span>

        <span class="c1"># A function for finding the signed difference between two angles. This</span>
        <span class="c1"># is needed for angular separation comparison to avoid angle wrapping.</span>
        <span class="k">def</span> <span class="nf">_sgn_ang_diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find the signed difference between two angles. Assumes degrees.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="mi">180</span> <span class="o">-</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>

        <span class="c1"># The maximum that two entries can be separated while still being the</span>
        <span class="c1"># same target. The configuration file&#39;s units is arcseconds, convert to</span>
        <span class="c1"># degrees.</span>
        <span class="n">MAX_SEP_AECSEC</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_MAXIMUM_INTERSECTION_SEPARATION</span>
        <span class="n">MAX_SEP_DEG</span> <span class="o">=</span> <span class="n">MAX_SEP_AECSEC</span> <span class="o">/</span> <span class="mi">3600</span>

        <span class="c1"># The size of a star, used for the photometric count determination. As</span>
        <span class="c1"># the star photon counts function uses degrees, a conversion is done</span>
        <span class="c1"># to convert from arcseconds to degrees.</span>
        <span class="n">STAR_RADIUS_DEG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_radius</span> <span class="o">/</span> <span class="mi">3600</span>

        <span class="c1"># Find the closest star within the photometric table for each</span>
        <span class="c1"># astrometric star. It is assumed that the two closest entries are</span>
        <span class="c1"># the same star.</span>
        <span class="k">for</span> <span class="n">rowdex</span> <span class="ow">in</span> <span class="n">astrometric_table</span><span class="p">:</span>
            <span class="c1"># Reassignment for ease.</span>
            <span class="n">ra_astro_row</span> <span class="o">=</span> <span class="n">rowdex</span><span class="p">[</span><span class="s2">&quot;ra_astro&quot;</span><span class="p">]</span>
            <span class="n">dec_astro_row</span> <span class="o">=</span> <span class="n">rowdex</span><span class="p">[</span><span class="s2">&quot;dec_astro&quot;</span><span class="p">]</span>
            <span class="c1"># Assuming tangential projection and pythagoras distances for</span>
            <span class="c1"># finding closest star. Special function used to handle angle</span>
            <span class="c1"># wrapping.</span>
            <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">_sgn_ang_diff</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">ra_astro_row</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">ra_phototable</span><span class="p">)</span>
            <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">_sgn_ang_diff</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">dec_astro_row</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">dec_phototable</span><span class="p">)</span>
            <span class="c1"># Finding minimum separation.</span>
            <span class="n">separations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ra_diff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dec_diff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">minimum_separation_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">separations</span><span class="p">)</span>
            <span class="n">minimum_separation</span> <span class="o">=</span> <span class="n">separations</span><span class="p">[</span><span class="n">minimum_separation_index</span><span class="p">]</span>

            <span class="c1"># If the separation exceeds the maximum set, then there simply is</span>
            <span class="c1"># no pair.</span>
            <span class="k">if</span> <span class="n">MAX_SEP_DEG</span> <span class="o">&lt;</span> <span class="n">minimum_separation</span><span class="p">:</span>
                <span class="c1"># No luck, no matching entry.</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Entries are good enough to match.</span>

                <span class="c1"># The difference between the two locations in space may be</span>
                <span class="c1"># useful.</span>
                <span class="n">separation</span> <span class="o">=</span> <span class="n">minimum_separation</span>
                <span class="c1"># The total counts of this star. This table is going to be</span>
                <span class="c1"># used for photometric calculations so having this in the table</span>
                <span class="c1"># is a useful convince.</span>
                <span class="n">dn_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_star_photon_counts_coordinate</span><span class="p">(</span>
                    <span class="n">ra</span><span class="o">=</span><span class="n">ra_astro_row</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_astro_row</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">STAR_RADIUS_DEG</span>
                <span class="p">)</span>

                <span class="c1"># The photometric table row at the found index is the matching</span>
                <span class="c1"># star, combine the data entries.</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">photometric_table</span><span class="p">[</span><span class="n">minimum_separation_index</span><span class="p">])</span>
                    <span class="o">|</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rowdex</span><span class="p">)</span>
                    <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;separation&quot;</span><span class="p">:</span> <span class="n">separation</span><span class="p">}</span>
                    <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="n">dn_counts</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">intersection_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># All done.</span>
        <span class="k">return</span> <span class="n">intersection_table</span>

    <span class="k">def</span> <span class="nf">__calculate_sky_counts_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hint</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate a mask which blocks out all but the sky for sky counts</span>
<span class="sd">        determination.</span>

<span class="sd">        The method used is to exclude the regions where stars exist (as</span>
<span class="sd">        determined by the star tables) and also the central region</span>
<span class="sd">        of the image (as it is expected that there is a science object there).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sky_counts_mask : float</span>
<span class="sd">            The mask which masks out which is not interesting regarding sky</span>
<span class="sd">            count calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extracting the needed information from the computed solution values.</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">_original_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">arcsec_pixel_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">pixel_scale</span>
        <span class="n">photo_star_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_table</span>
        <span class="n">astro_star_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">star_table</span>
        <span class="c1"># Information about the data array.</span>
        <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Using the photometric star table as the locations for the stars is</span>
        <span class="c1"># likely more accurate and also would theoretically exclude more stars</span>
        <span class="c1"># than the astrometric star table. But, there is no harm in using both.</span>
        <span class="c1"># The pixel values for the photometric table are derived from the WCS.</span>
        <span class="n">photo_x</span><span class="p">,</span> <span class="n">photo_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">sky_to_pixel_coordinates</span><span class="p">(</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">photo_star_table</span><span class="p">[</span><span class="s2">&quot;ra_photo&quot;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">photo_star_table</span><span class="p">[</span><span class="s2">&quot;dec_photo&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">photo_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">photo_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">photo_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">photo_y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">astro_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">astro_star_table</span><span class="p">[</span><span class="s2">&quot;pixel_x&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">astro_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">astro_star_table</span><span class="p">[</span><span class="s2">&quot;pixel_y&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># The pixel locations of all detected stars.</span>
        <span class="n">stars_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">photo_x</span><span class="p">,</span> <span class="n">astro_x</span><span class="p">)</span>
        <span class="n">stars_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">photo_y</span><span class="p">,</span> <span class="n">astro_y</span><span class="p">)</span>
        <span class="c1"># The length of the masking box region for a star, being generous on</span>
        <span class="c1"># the half definition for odd sized boxes.</span>
        <span class="n">STAR_RADIUS_AS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_radius</span>
        <span class="n">STAR_RADIUS_PIXEL</span> <span class="o">=</span> <span class="n">STAR_RADIUS_AS</span> <span class="o">/</span> <span class="n">arcsec_pixel_scale</span>
        <span class="n">HALF_BOX_LENGTH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">STAR_RADIUS_PIXEL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Defining the star mask to mask regions where stars have been</span>
        <span class="c1"># detected.</span>
        <span class="n">star_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">colindex</span><span class="p">,</span> <span class="n">rowindex</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stars_x</span><span class="p">,</span> <span class="n">stars_y</span><span class="p">):</span>
            <span class="c1"># Need to take into account that if the pixel values are negative</span>
            <span class="c1"># because of search radius of the photometric cone and the mapping</span>
            <span class="c1"># to pixel coordinates, then it would wrap around from the other</span>
            <span class="c1"># end and mask out non-stars.</span>
            <span class="k">if</span> <span class="n">colindex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rowindex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># These are not in the array and don&#39;t really matter for</span>
                <span class="c1"># masking.</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The points should be valid.</span>
                <span class="n">star_mask</span><span class="p">[</span>
                    <span class="n">rowindex</span> <span class="o">-</span> <span class="n">HALF_BOX_LENGTH</span> <span class="p">:</span> <span class="n">rowindex</span> <span class="o">+</span> <span class="n">HALF_BOX_LENGTH</span><span class="p">,</span>
                    <span class="n">colindex</span> <span class="o">-</span> <span class="n">HALF_BOX_LENGTH</span> <span class="p">:</span> <span class="n">colindex</span> <span class="o">+</span> <span class="n">HALF_BOX_LENGTH</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Masking the center region as well as a science object is expected</span>
        <span class="c1"># to be there.</span>
        <span class="n">SCIENCE_RADIUS</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_SCIENCE_RADIUS_MASK_PIXELS</span>
        <span class="n">SCI_HALF_WIDTH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">SCIENCE_RADIUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">science_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">science_mask</span><span class="p">[</span>
            <span class="n">n_rows</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">SCI_HALF_WIDTH</span> <span class="p">:</span> <span class="n">n_rows</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">SCI_HALF_WIDTH</span><span class="p">,</span>
            <span class="n">n_cols</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">SCI_HALF_WIDTH</span> <span class="p">:</span> <span class="n">n_cols</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">SCI_HALF_WIDTH</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Mask the edges of the array as often they are spurious and may have</span>
        <span class="c1"># bleed over from electronics onto the detector itself. This also is a</span>
        <span class="c1"># way of ignoring that the slices above may not be proper, hence the</span>
        <span class="c1"># edge value.</span>
        <span class="n">EDGE_WIDTH</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_EDGE_WIDTH_MASK_PIXELS</span>
        <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">edge_mask</span><span class="p">[</span><span class="n">EDGE_WIDTH</span><span class="p">:</span><span class="o">-</span><span class="n">EDGE_WIDTH</span><span class="p">,</span> <span class="n">EDGE_WIDTH</span><span class="p">:</span><span class="o">-</span><span class="n">EDGE_WIDTH</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Finally, making any values which do not really make any sense or are</span>
        <span class="c1"># already NaN.</span>
        <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_array</span><span class="p">))</span>

        <span class="c1"># Adding all of the masks.</span>
        <span class="n">sky_counts_mask</span> <span class="o">=</span> <span class="n">star_mask</span> <span class="o">|</span> <span class="n">science_mask</span> <span class="o">|</span> <span class="n">edge_mask</span> <span class="o">|</span> <span class="n">nan_mask</span>
        <span class="n">sky_counts_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sky_counts_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sky_counts_mask</span>

    <span class="k">def</span> <span class="nf">__calculate_sky_counts_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the background sky value, in counts, from the image.</span>
<span class="sd">        Obviously needed for photometric calibrations.</span>

<span class="sd">        The regions outside of the sky mask represent the sky and the sky</span>
<span class="sd">        counts is extracted from that.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sky_counts : float</span>
<span class="sd">            The total number of counts, in DN that, on average, the sky</span>
<span class="sd">            contributes per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extracting the needed information from the computed solution values.</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">_original_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># If the sky mask has not been computed, then it should be determined.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sky_counts_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky_counts_mask</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Calculate the mask first, it is strange that this is called first.</span>
            <span class="n">sky_counts_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_sky_counts_mask</span><span class="p">()</span>

        <span class="c1"># Apply the sky mask.</span>
        <span class="n">masked_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">sky_counts_mask</span><span class="p">)</span>
        <span class="n">sky_data_values</span> <span class="o">=</span> <span class="n">masked_data_array</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>

        <span class="c1"># Computing the sky value based on the star-masked array.</span>
        <span class="n">sky_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sky_data_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sky_counts</span>

<div class="viewcode-block" id="PhotometricSolution._calculate_zero_point"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution._calculate_zero_point">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_zero_point</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function calculates the photometric zero-point of the image</span>
<span class="sd">        provided the data in the intersection star table.</span>

<span class="sd">        This function uses the set exposure time and the intersection star</span>
<span class="sd">        table. The band is also assumed from the initial parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exposure_time : float</span>
<span class="sd">            How long, in seconds, the image in question was exposed for.</span>
<span class="sd">        filter_name : string, default = None</span>
<span class="sd">            A single character string describing the name of the filter band that</span>
<span class="sd">            this image was taken in. Currently, it assumes the MKO/SDSS visual</span>
<span class="sd">            filters. If it is None, then this function does nothing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        zero_point : float</span>
<span class="sd">            The zero point of this image. This is computed as a mean of all of</span>
<span class="sd">            the calculated zero points.</span>
<span class="sd">        zero_point_error : float</span>
<span class="sd">            The standard deviation of the zero points calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Obtaining the needed information.</span>
        <span class="n">inter_star_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_star_table</span>

        <span class="c1"># The exposure time information.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>

        <span class="c1"># The filter name, check that it is a valid expected filter which the</span>
        <span class="c1"># photometric engines and vehicle functions are expected to deal with.</span>

        <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The filter is not provided and thus photometry cannot be</span>
            <span class="c1"># performed.</span>
            <span class="n">zero_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point</span>
            <span class="n">zero_point_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_error</span>
            <span class="k">return</span> <span class="n">zero_point</span><span class="p">,</span> <span class="n">zero_point_error</span>
        <span class="k">elif</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">library</span><span class="o">.</span><span class="n">phototable</span><span class="o">.</span><span class="n">OPIHI_FILTERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span>
                <span class="s2">&quot;The filter name provided `</span><span class="si">{f}</span><span class="s2">` is not a filter that is supported by&quot;</span>
                <span class="s2">&quot; OpihiExarata&#39;s supported photometric engines and vehicle functions&quot;</span>
                <span class="s2">&quot; and therefore cannot be used to derive a photometric solution.&quot;</span>
                <span class="s2">&quot; Opihi&#39;s filters: </span><span class="si">{of}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">=</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="n">library</span><span class="o">.</span><span class="n">phototable</span><span class="o">.</span><span class="n">OPIHI_FILTERS</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_filters</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span>
                <span class="s2">&quot;The filter name provided `</span><span class="si">{f}</span><span class="s2">` is not a filter with photometry data&quot;</span>
                <span class="s2">&quot; available from the given photometry engine and vehicle. There is no&quot;</span>
                <span class="s2">&quot; data from the photometric database(s) to derive a photometric&quot;</span>
                <span class="s2">&quot; solution. Available filters: </span><span class="si">{af}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">=</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">af</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_filters</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span>

        <span class="c1"># Extract the proper photometric values for the filter being used.</span>
        <span class="n">filter_table_header</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{f}</span><span class="s2">_mag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filter_name</span><span class="p">)</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">inter_star_table</span><span class="p">[</span><span class="n">filter_table_header</span><span class="p">]</span>
        <span class="c1"># And the count data.</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">inter_star_table</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span>
        <span class="c1"># Instrument magnitudes.</span>
        <span class="n">sqrt5_100</span> <span class="o">=</span> <span class="mf">2.51188643151</span>
        <span class="n">inst_magnitude</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt5_100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">exposure_time</span><span class="p">)</span>

        <span class="c1"># We filter the stars so that we avoid using stars and targets</span>
        <span class="c1"># which otherwise would skew our results.</span>
        <span class="c1"># Stars which are too bright saturate our detector. We limit based on</span>
        <span class="c1"># the magnitude as specified. A dimmer object has a higher magnitude.</span>
        <span class="n">DIM_MAG</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_ZERO_POINT_DIMMEST_MAGNITUDE</span>
        <span class="n">BRIGHT_MAG</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_ZERO_POINT_BRIGHTEST_MAGNITUDE</span>
        <span class="n">invalid_filter_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">BRIGHT_MAG</span> <span class="o">&lt;=</span> <span class="n">magnitude</span><span class="p">,</span> <span class="n">magnitude</span> <span class="o">&lt;=</span> <span class="n">DIM_MAG</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># We only can use count data which is actually valid, using invalid</span>
        <span class="c1"># count data corrupts our instrument magnitudes and everything else</span>
        <span class="c1"># down the line.</span>
        <span class="n">invalid_instrument_magnitude</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># The valid points that we can use are those not caught with the</span>
        <span class="c1"># filter.</span>
        <span class="n">valid_points</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">invalid_filter_magnitude</span> <span class="o">|</span> <span class="n">invalid_instrument_magnitude</span><span class="p">)</span>
        <span class="c1"># Using only the remaining/valid targets for the photometric</span>
        <span class="c1"># calculation.</span>
        <span class="n">valid_magnitude</span> <span class="o">=</span> <span class="n">magnitude</span><span class="p">[</span><span class="n">valid_points</span><span class="p">]</span>
        <span class="n">valid_inst_magnitude</span> <span class="o">=</span> <span class="n">inst_magnitude</span><span class="p">[</span><span class="n">valid_points</span><span class="p">]</span>

        <span class="c1"># Zero points via the definition equation</span>
        <span class="n">zero_points</span> <span class="o">=</span> <span class="n">valid_magnitude</span> <span class="o">-</span> <span class="n">valid_inst_magnitude</span>
        <span class="c1"># Zero points are technically a magnitude so we can only find its</span>
        <span class="c1"># average by converting to linear space.</span>
        <span class="n">zero_point</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt5_100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">zero_points</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)))</span>
        <span class="c1"># We use the error on the mean, but instead we use medians and its</span>
        <span class="c1"># standard deviation equivalent to be robust to bad data points.</span>
        <span class="n">n_stars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">zero_points</span><span class="p">))</span>
        <span class="n">zero_point_deviation</span> <span class="o">=</span> <span class="n">sp_stats</span><span class="o">.</span><span class="n">median_abs_deviation</span><span class="p">(</span>
            <span class="n">zero_points</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span>
        <span class="p">)</span>
        <span class="n">zero_point_error</span> <span class="o">=</span> <span class="n">zero_point_deviation</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_stars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zero_point</span><span class="p">,</span> <span class="n">zero_point_error</span></div>

<div class="viewcode-block" id="PhotometricSolution.calculate_star_photon_counts_coordinate"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution.calculate_star_photon_counts_coordinate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_star_photon_counts_coordinate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total number of photometric counts at an RA DEC. The</span>
<span class="sd">        counts are already corrected for the sky counts.</span>

<span class="sd">        This function does not check if a star is actually there. This function</span>
<span class="sd">        is a wrapper around its pixel version, converting via the WCS solution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ra : float</span>
<span class="sd">            The right ascension in degrees.</span>
<span class="sd">        dec : float</span>
<span class="sd">            The declination in degrees.</span>
<span class="sd">        radius : float</span>
<span class="sd">            The radius of the circular aperture to be considered, in degrees.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        photon_counts : float</span>
<span class="sd">            The sum of the sky corrected counts for the region defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extracting the needed parameters.</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">wcs</span>
        <span class="n">arcsec_pixel_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">pixel_scale</span>

        <span class="c1"># Translating the coordinates to the usable pixels.</span>
        <span class="n">photo_x</span><span class="p">,</span> <span class="n">photo_y</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel_values</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>

        <span class="c1"># The radius is in angular degrees, converting it to pixels via the</span>
        <span class="c1"># scale. Converting the astrometrics scale to degrees as well as the</span>
        <span class="c1"># input unit is that.</span>
        <span class="n">pixel_radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="p">(</span><span class="n">arcsec_pixel_scale</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">))</span>

        <span class="c1"># Using the pixel version because there is little need to implement</span>
        <span class="c1"># it all again.</span>
        <span class="n">photon_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_star_photon_counts_pixel</span><span class="p">(</span>
            <span class="n">pixel_x</span><span class="o">=</span><span class="n">photo_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="o">=</span><span class="n">photo_y</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">pixel_radius</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">photon_counts</span></div>

<div class="viewcode-block" id="PhotometricSolution.calculate_star_photon_counts_pixel"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution.calculate_star_photon_counts_pixel">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_star_photon_counts_pixel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pixel_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total number of photometric counts at a pixel</span>
<span class="sd">        location. The counts are already corrected for the sky counts.</span>

<span class="sd">        This function does not check if a star is actually there.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pixel_x : int</span>
<span class="sd">            The x coordinate of the center pixel.</span>
<span class="sd">        pixel_y : int</span>
<span class="sd">            The y coordinate of the center pixel.</span>
<span class="sd">        radius : float</span>
<span class="sd">            The radius of the circular aperture to be considered in pixel</span>
<span class="sd">            counts. This is in pixel units.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        photon_counts : float</span>
<span class="sd">            The sum of the sky corrected counts for the region defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extracting the needed parameters.</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">_original_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sky_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky_counts</span>

        <span class="c1"># Taking out the sky contribution.</span>
        <span class="n">data_array_nosky</span> <span class="o">=</span> <span class="n">data_array</span> <span class="o">-</span> <span class="n">sky_counts</span>

        <span class="c1"># A circular mask is used to define the star.</span>
        <span class="n">star_mask</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">create_circular_mask</span><span class="p">(</span>
            <span class="n">array</span><span class="o">=</span><span class="n">data_array_nosky</span><span class="p">,</span> <span class="n">center_x</span><span class="o">=</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">center_y</span><span class="o">=</span><span class="n">pixel_y</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span>
        <span class="p">)</span>
        <span class="n">star_array_nosky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array_nosky</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">star_mask</span><span class="p">)</span>

        <span class="c1"># Summing up the total counts within the star region as defined by the</span>
        <span class="c1"># star mask, this is the total photon counts.</span>
        <span class="n">photon_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">star_array_nosky</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">photon_counts</span></div>

<div class="viewcode-block" id="PhotometricSolution.calculate_star_aperture_magnitude"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution.PhotometricSolution.calculate_star_aperture_magnitude">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_star_aperture_magnitude</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pixel_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function calculates the photometric aperture magnitude of a</span>
<span class="sd">        star (or any PSF-like object) from the zero-point as provided by the</span>
<span class="sd">        photometric solution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pixel_x : int</span>
<span class="sd">            The x coordinate of the center pixel of the star/target.</span>
<span class="sd">        pixel_y : int</span>
<span class="sd">            The y coordinate of the center pixel of the star/target.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        star_magnitude : float</span>
<span class="sd">            The magnitude of the star/PSF as determined by aperture photometry.</span>
<span class="sd">        star_magnitude_error : float</span>
<span class="sd">            The error on the magnitude after errors have been propagated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The radius of the PSF for calculating the magnitude of a target</span>
        <span class="c1"># must be the same as those which was used to derive the phototable</span>
        <span class="c1"># and the zero-point. We need to convert the configuration</span>
        <span class="c1"># parameter from arcseconds to pixels.</span>
        <span class="n">arcsec_pixel_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astrometrics</span><span class="o">.</span><span class="n">pixel_scale</span>
        <span class="n">pixel_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_radius</span> <span class="o">/</span> <span class="p">(</span><span class="n">arcsec_pixel_scale</span><span class="p">)</span>

        <span class="c1"># The exposure time information.</span>
        <span class="n">exposure_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span>

        <span class="c1"># Obtain the number of counts which this star/PSF has.</span>
        <span class="n">star_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_star_photon_counts_pixel</span><span class="p">(</span>
            <span class="n">pixel_x</span><span class="o">=</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="o">=</span><span class="n">pixel_y</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">pixel_radius</span>
        <span class="p">)</span>
        <span class="c1"># Assuming Poisson statistics for the photon counting of the star&#39;s</span>
        <span class="c1"># aperture.</span>
        <span class="n">star_counts_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">star_counts</span><span class="p">)</span>

        <span class="c1"># Provided the zero point and its error.</span>
        <span class="n">zero_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point</span>
        <span class="n">zero_point_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_error</span>

        <span class="c1"># Calculating the magnitude.</span>
        <span class="n">sqrt5_100</span> <span class="o">=</span> <span class="mf">2.51188643151</span>
        <span class="n">star_magnitude</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt5_100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">star_counts</span> <span class="o">/</span> <span class="n">exposure_time</span><span class="p">)</span> <span class="o">+</span> <span class="n">zero_point</span>

        <span class="c1"># Calculating the error as propagated.</span>
        <span class="n">ln10</span> <span class="o">=</span> <span class="mf">2.302585092994046</span>
        <span class="n">star_magnitude_variance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sqrt5_100</span> <span class="o">*</span> <span class="n">star_counts_error</span> <span class="o">/</span> <span class="p">(</span><span class="n">star_counts</span> <span class="o">*</span> <span class="n">ln10</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">zero_point_error</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">star_magnitude_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">star_magnitude_variance</span><span class="p">)</span>

        <span class="c1"># All done.</span>
        <span class="k">return</span> <span class="n">star_magnitude</span><span class="p">,</span> <span class="n">star_magnitude_error</span></div></div>


<div class="viewcode-block" id="_vehicle_panstarrs_mast_web_api"><a class="viewcode-back" href="../../../code/opihiexarata.photometry.solution.html#opihiexarata.photometry.solution._vehicle_panstarrs_mast_web_api">[docs]</a><span class="k">def</span> <span class="nf">_vehicle_panstarrs_mast_web_api</span><span class="p">(</span><span class="n">ra</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A vehicle function for photometric solutions. Extract photometric</span>
<span class="sd">    data using the PanSTARRS database accessed via the MAST API.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra : float</span>
<span class="sd">        The right ascension of the center of the area to extract from,</span>
<span class="sd">        in degrees.</span>
<span class="sd">    dec : float</span>
<span class="sd">        The declination of the center of the area to extract from,</span>
<span class="sd">        in degrees.</span>
<span class="sd">    radius : float</span>
<span class="sd">        The search radius from the center that defines the search area.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    photometry_results : dictionary</span>
<span class="sd">        The results of the photometry engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The results of the solve.</span>
    <span class="n">photometry_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Instance of the PanSTARRS web api client, there does not need to be</span>
    <span class="c1"># an API key so far. Sometimes SSL issues arise though.</span>
    <span class="n">SSL_VERIFY</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">API_CONNECTION_ENABLE_SSL_CHECKS</span>
    <span class="n">panstarrs_client</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">PanstarrsMastWebAPIEngine</span><span class="p">(</span><span class="n">verify_ssl</span><span class="o">=</span><span class="n">SSL_VERIFY</span><span class="p">)</span>

    <span class="c1"># The columns of relevance to this photometric solver, and their</span>
    <span class="c1"># associations with the expected photometric star table that is</span>
    <span class="c1"># expected output.</span>
    <span class="n">using_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra_photo&quot;</span><span class="p">:</span> <span class="s2">&quot;raMean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dec_photo&quot;</span><span class="p">:</span> <span class="s2">&quot;decMean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;g_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;gMeanPSFMag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;g_err&quot;</span><span class="p">:</span> <span class="s2">&quot;gMeanPSFMagErr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;r_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;rMeanPSFMag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;r_err&quot;</span><span class="p">:</span> <span class="s2">&quot;rMeanPSFMagErr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;i_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;iMeanPSFMag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;i_err&quot;</span><span class="p">:</span> <span class="s2">&quot;iMeanPSFMagErr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;z_mag&quot;</span><span class="p">:</span> <span class="s2">&quot;zMeanPSFMag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;z_err&quot;</span><span class="p">:</span> <span class="s2">&quot;zMeanPSFMagErr&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Obtain the stars within the region in question. The masked version</span>
    <span class="c1"># of this call allows for better handling of invalid entries in</span>
    <span class="c1"># PanSTARRS data. Also, we only want targets with photometric results.</span>
    <span class="n">MINIMUM_DETECT</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PHOTOMETRY_MINIMUM_FILTER_OBSERVATIONS</span>
    <span class="n">DR_VER</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PANSTARRS_MAST_API_DATA_RELEASE_VERSION</span>
    <span class="n">MAX_ROW</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">PANSTARRS_MAST_API_MAXIMUM_DATA_ROWS</span>
    <span class="n">masked_star_table</span> <span class="o">=</span> <span class="n">panstarrs_client</span><span class="o">.</span><span class="n">masked_cone_search</span><span class="p">(</span>
        <span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span>
        <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">detections</span><span class="o">=</span><span class="n">MINIMUM_DETECT</span><span class="p">,</span>
        <span class="n">color_detections</span><span class="o">=</span><span class="n">MINIMUM_DETECT</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">using_columns</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="n">max_rows</span><span class="o">=</span><span class="n">MAX_ROW</span><span class="p">,</span>
        <span class="n">data_release</span><span class="o">=</span><span class="n">DR_VER</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># To ensure that the format of the table is as expected for the output</span>
    <span class="c1"># of this vehicle function, the columns must be renamed to their</span>
    <span class="c1"># prescribed names.</span>
    <span class="c1"># When pulling the table data, the column names are built to be case</span>
    <span class="c1"># insensitive, but Astropy tables are case sensitive.</span>
    <span class="n">current_column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="n">using_columns</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">expected_column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">using_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">masked_star_table</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">current_column_names</span><span class="p">,</span> <span class="n">expected_column_names</span><span class="p">)</span>

    <span class="c1"># This photometry table is only a partial one, we pad it to be a standard</span>
    <span class="c1"># table here.</span>
    <span class="n">photo_star_table</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">phototable</span><span class="o">.</span><span class="n">fill_incomplete_photometry_table</span><span class="p">(</span>
        <span class="n">partial_table</span><span class="o">=</span><span class="n">masked_star_table</span>
    <span class="p">)</span>
    <span class="c1"># Only these filters are available from the PanSTARRS database.</span>
    <span class="n">available_filters</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>

    <span class="c1"># Collecting the solution information.</span>
    <span class="n">photometry_results</span><span class="p">[</span><span class="s2">&quot;star_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_star_table</span>
    <span class="n">photometry_results</span><span class="p">[</span><span class="s2">&quot;available_filters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">available_filters</span>
    <span class="c1"># All done.</span>
    <span class="k">return</span> <span class="n">photometry_results</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kenji Sparrow Emerson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>